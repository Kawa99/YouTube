{% extends 'base.html' %}

{% block title %}Channel Scraper - YouTube Tracker{% endblock %}

{% block content %}
<section class="space-y-10">
    <header class="space-y-3">
        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500 dark:text-slate-400">Bulk Extraction</p>
        <h1 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-slate-100">YouTube Channel Scraper</h1>
        <p class="max-w-3xl text-slate-600 dark:text-slate-300">Queue a background scrape for an entire channel and monitor progress in real time.</p>
    </header>

    <div class="grid gap-6 lg:grid-cols-[minmax(0,1.6fr)_minmax(0,1fr)]">
        <article class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <form method="post" class="space-y-6">
                <div class="space-y-2.5">
                    <label for="channel_url" class="text-sm font-medium text-slate-700 dark:text-slate-300">Channel URL</label>
                    <input
                        type="url"
                        name="channel_url"
                        id="channel_url"
                        value="{{ request.form.get('channel_url', '') }}"
                        class="w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-slate-900 placeholder:text-slate-400 shadow-sm outline-none transition focus:border-rose-500 focus:ring-2 focus:ring-rose-500 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500"
                        placeholder="https://www.youtube.com/@channelname"
                        required
                    >
                </div>

                <div class="space-y-2.5">
                    <label for="max_videos" class="text-sm font-medium text-slate-700 dark:text-slate-300">Maximum Videos to Process</label>
                    <input
                        type="number"
                        name="max_videos"
                        id="max_videos"
                        value="{{ request.form.get('max_videos', '50') }}"
                        min="1"
                        max="1000"
                        class="w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-slate-900 shadow-sm outline-none transition focus:border-rose-500 focus:ring-2 focus:ring-rose-500 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100"
                        required
                    >
                </div>

                <button type="submit" class="inline-flex items-center rounded-xl bg-rose-600 px-5 py-3 text-sm font-semibold text-white transition-colors hover:bg-rose-700">
                    Start Channel Scraping
                </button>
            </form>
        </article>

        <aside class="space-y-4">
            <article class="rounded-2xl border border-sky-200 border-l-4 border-l-sky-500 bg-sky-50/85 p-5 dark:border-sky-900/70 dark:border-l-sky-400 dark:bg-sky-950/30">
                <h2 class="text-sm font-semibold text-sky-900 dark:text-sky-200">Supported URL Formats</h2>
                <ul class="mt-3 space-y-1.5 text-sm text-sky-800 dark:text-sky-100/90">
                    <li>https://www.youtube.com/@channelname</li>
                    <li>https://www.youtube.com/channel/UC...</li>
                    <li>https://www.youtube.com/c/channelname</li>
                    <li>https://www.youtube.com/user/username</li>
                </ul>
            </article>

            <article class="rounded-2xl border border-amber-200 border-l-4 border-l-amber-500 bg-amber-50/85 p-5 dark:border-amber-900/70 dark:border-l-amber-400 dark:bg-amber-950/25">
                <h2 class="text-sm font-semibold text-amber-900 dark:text-amber-200">Operational Notes</h2>
                <ul class="mt-3 space-y-1.5 text-sm text-amber-800 dark:text-amber-100/90">
                    <li>Large batch sizes increase runtime because each video triggers multiple API requests.</li>
                    <li>Some videos can fail due to privacy settings or unavailable transcripts.</li>
                    <li>Progress updates are polled live while processing continues in the background worker.</li>
                </ul>
            </article>
        </aside>
    </div>

    {% if job_id %}
    <section id="job-progress" data-job-id="{{ job_id }}" class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="flex flex-wrap items-center justify-between gap-3">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Active Job Dashboard</h2>
            <span id="job-status" class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-200">queued</span>
        </div>

        <p id="job-message" class="mt-3 text-sm text-slate-600 dark:text-slate-300">Waiting for worker...</p>

        <div class="mt-5">
            <div class="flex items-center justify-between text-xs text-slate-500 dark:text-slate-400">
                <span>Progress</span>
                <span id="job-progress-text" class="font-mono">0%</span>
            </div>
            <div class="mt-2 h-2 overflow-hidden rounded-full bg-slate-100 dark:bg-slate-700" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                <div id="job-progress-bar" class="h-full w-0 rounded-full bg-rose-500 transition-[width] duration-500 ease-out" style="width: 0%;" aria-valuenow="0"></div>
            </div>
        </div>

        <div class="mt-6 grid grid-cols-2 gap-3 lg:grid-cols-4">
            <div class="rounded-xl border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-900/40">
                <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Total</p>
                <p id="job-total" class="mt-1 font-mono text-xl font-semibold text-slate-900 dark:text-slate-100">0</p>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-900/40">
                <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Inserted</p>
                <p id="job-processed" class="mt-1 font-mono text-xl font-semibold text-slate-900 dark:text-slate-100">0</p>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-900/40">
                <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Failed</p>
                <p id="job-failed" class="mt-1 font-mono text-xl font-semibold text-slate-900 dark:text-slate-100">0</p>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-900/40">
                <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Skipped</p>
                <p id="job-skipped" class="mt-1 font-mono text-xl font-semibold text-slate-900 dark:text-slate-100">0</p>
            </div>
        </div>

        <p class="mt-5 text-sm text-slate-600 dark:text-slate-300">
            <span class="font-medium text-slate-700 dark:text-slate-200">Current video:</span>
            <code id="job-current" class="ml-2 rounded-md border border-slate-200 bg-slate-50 px-2 py-1 font-mono text-xs text-slate-700 dark:border-slate-700 dark:bg-slate-900/50 dark:text-slate-200">-</code>
        </p>
    </section>
    {% endif %}
</section>

{% if job_id %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    (function () {
        const container = document.getElementById("job-progress");
        if (!container) {
            return;
        }

        const jobId = container.dataset.jobId;
        const statusEl = document.getElementById("job-status");
        const messageEl = document.getElementById("job-message");
        const progressBarEl = document.getElementById("job-progress-bar");
        const progressTextEl = document.getElementById("job-progress-text");
        const totalEl = document.getElementById("job-total");
        const processedEl = document.getElementById("job-processed");
        const failedEl = document.getElementById("job-failed");
        const skippedEl = document.getElementById("job-skipped");
        const currentEl = document.getElementById("job-current");
        const terminalStatuses = new Set(["completed", "failed"]);
        const pollIntervalMs = 2000;
        const initialJob = {{ job|tojson }};
        let socket = null;
        let pollTimer = null;
        let socketConnected = false;

        function isTerminalStatus(status) {
            return terminalStatuses.has(status);
        }

        function updateStatusBadge(status) {
            statusEl.className = "inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium";

            if (status === "completed") {
                statusEl.classList.add("bg-emerald-100", "text-emerald-700", "dark:bg-emerald-900/40", "dark:text-emerald-300");
            } else if (status === "failed") {
                statusEl.classList.add("bg-red-100", "text-red-700", "dark:bg-red-900/40", "dark:text-red-300");
            } else if (status === "running") {
                statusEl.classList.add("bg-rose-100", "text-rose-700", "dark:bg-rose-900/40", "dark:text-rose-300");
            } else {
                statusEl.classList.add("bg-slate-100", "text-slate-700", "dark:bg-slate-700", "dark:text-slate-200");
            }

            statusEl.textContent = status;
        }

        function updateDashboard(data) {
            if (!data || typeof data !== "object") {
                return;
            }

            const progress = Math.max(0, Math.min(100, Number(data.progress_pct || 0)));
            const status = data.status || statusEl.textContent || "queued";

            updateStatusBadge(status);
            if (data.message) {
                messageEl.textContent = data.message;
            }

            if (data.total_videos !== undefined) {
                totalEl.textContent = data.total_videos;
            }
            if (data.processed !== undefined) {
                processedEl.textContent = data.processed;
            }
            if (data.failed !== undefined) {
                failedEl.textContent = data.failed;
            }
            if (data.skipped !== undefined) {
                skippedEl.textContent = data.skipped;
            }
            if (data.current_video_id !== undefined) {
                currentEl.textContent = data.current_video_id || "-";
            }

            progressBarEl.style.width = `${progress}%`;
            progressBarEl.setAttribute("aria-valuenow", String(progress));
            progressTextEl.textContent = `${progress}%`;

            if (isTerminalStatus(status)) {
                if (pollTimer) {
                    clearInterval(pollTimer);
                    pollTimer = null;
                }
                if (socket && socket.connected) {
                    socket.disconnect();
                }
            }
        }

        async function fetchJobStatus() {
            try {
                const response = await fetch(`/api/channel-jobs/${encodeURIComponent(jobId)}`, {
                    headers: {
                        "Accept": "application/json"
                    },
                    cache: "no-store"
                });

                if (!response.ok) {
                    throw new Error(`status ${response.status}`);
                }

                const payload = await response.json();
                updateDashboard(payload);
            } catch (_error) {
                if (!socketConnected && !isTerminalStatus(statusEl.textContent)) {
                    messageEl.textContent = "Realtime disconnected. Polling for updates...";
                }
            }
        }

        if (initialJob) {
            updateDashboard(initialJob);
        }

        fetchJobStatus();
        pollTimer = setInterval(fetchJobStatus, pollIntervalMs);

        if (typeof io === "function") {
            socket = io();

            socket.on("connect", function () {
                socketConnected = true;
                socket.emit("join", { jobId: jobId });
                fetchJobStatus();
            });

            socket.on("progress_update", function (data) {
                updateDashboard(data);
            });

            socket.on("disconnect", function () {
                socketConnected = false;
                if (!isTerminalStatus(statusEl.textContent)) {
                    messageEl.textContent = "Realtime disconnected. Polling for updates...";
                }
            });
        }
    })();
</script>
{% endif %}
{% endblock %}
